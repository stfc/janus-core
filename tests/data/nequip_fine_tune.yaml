# Adapted from the nequip tutorial https://github.com/mir-group/nequip-tutorial

run: [train, test, val]
cutoff_radius: 5.0

num_layers: 4
l_max: 1
num_features: 32

chemical_symbols: [C, H, O, Zr]
model_type_names: ${chemical_symbols}

monitored_metric: val0_epoch/weighted_sum

data:
  _target_: nequip.data.datamodule.ASEDataModule
  seed: 456
  # Need to map our keys to nequips expected values.
  key_mapping:
    dft_energy: total_energy
    dft_forces: forces

  train_file_path: tests/data/mlip_train.xyz
  test_file_path: tests/data/mlip_train.xyz
  val_file_path: tests/data/mlip_train.xyz

  transforms:
    - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
      chemical_symbols: ${chemical_symbols}
    - _target_: nequip.data.transforms.NeighborListTransform
      r_max: ${cutoff_radius}

  train_dataloader:
    _target_: torch.utils.data.DataLoader
    batch_size: 5
    num_workers: 5
    shuffle: true
  val_dataloader:
    _target_: torch.utils.data.DataLoader
    batch_size: 10
    num_workers: ${data.train_dataloader.num_workers}
  test_dataloader: ${data.val_dataloader}

  stats_manager:
    _target_: nequip.data.CommonDataStatisticsManager
    dataloader_kwargs:
      batch_size: 10
    type_names: ${model_type_names}

trainer:
  _target_: lightning.Trainer
  accelerator: auto
  enable_checkpointing: true
  max_epochs: 2
  max_time: 00:01:00:00
  log_every_n_steps: 1

  logger:
    _target_: lightning.pytorch.loggers.csv_logs.CSVLogger
    name: train_log
    save_dir: ${hydra:runtime.output_dir}

  callbacks:

    - _target_: lightning.pytorch.callbacks.EarlyStopping
      monitor: ${monitored_metric}
      min_delta: 1e-3
      patience: 20

    - _target_: lightning.pytorch.callbacks.ModelCheckpoint
      monitor: ${monitored_metric}
      dirpath: ${hydra:runtime.output_dir}
      filename: best
      save_last: false

    - _target_: lightning.pytorch.callbacks.LearningRateMonitor
      logging_interval: epoch

training_module:
  _target_: nequip.train.EMALightningModule

  ema_decay: 0.999

  loss:
    _target_: nequip.train.EnergyForceLoss
    per_atom_energy: true
    coeffs:
      total_energy: 1.0
      forces: 1.0

  val_metrics:
    _target_: nequip.train.EnergyForceMetrics
    coeffs:
      total_energy_mae: 1.0
      forces_mae: 1.0
  train_metrics: ${training_module.val_metrics}
  test_metrics: ${training_module.val_metrics}

  optimizer:
    _target_: torch.optim.Adam
    lr: 0.01

  # Start from scratch
  model:
    _target_: nequip.model.ModelFromCheckpoint
    checkpoint_path: tests/models/nequip-checkpoint.ckpt
